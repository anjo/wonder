<?xml version="1.0"?>

<project name="Utils" default="all" basedir="../..">
    <target name="usage" depends="global.properties">
    
	<echo>

There are many ways to use this script:

1) from the command line to build the whole of WONDER
		build   --> create in ${build.root}
		install --> copy to ${wo.localroot}
		web     --> copy to ${wo.server.root}
		clean   --> remove .classes, .framework or .woa

2) to build your own projects that have the same layout as a wonder project
        ant -emacs -f ~/Wonder/Build/build/generic.xml  \
		-Dproject.type=application \
		-Dproject.name=SomeProject \
		-Dproject.principal.class=com.company.Application \
		-Dproject.dir=/path/to/my/SomeProject \
		-Duse.webobjects.d2w=true \
		-Dwonder.lib.root.bundles=Some/Root/Framework/Or/Other \
		-Dwonder.lib.root.bundles.embed=true \
		-Dwo.frameworks.bundles=Some/Library/Framework/Or/Other \
		-Dwo.frameworks.bundles.embed=true \
		generic.MODE

    or shorter:
    
        ant -emacs -f ~/Wonder/Build/build/generic.xml  \
		-propertyfile=build.properties
                generic.MODE
    
    where "build.properties" is a file with the options above in
    java-property format. 

    Leave out any option you don't want. Valid entries MODEs are:

		build  	--> create in ${build.root}
		install --> copy to ${wo.localroot}
		web     --> copy to ${wo.server.root}
		clean   --> remove .classes, .framework or .woa

    For MODE "install", "clean" and "web" it is sufficient to call:

        ant -emacs -f ~/Wonder/Build/build/generic.xml  \
		-Dproject.type=application \
		-Dproject.name=SomeProject \
		generic.MODE
	</echo>
    </target>

    <!-- When you add another sub-project, use this as a template
         We strongly encourage you to use one of the provided 
         templates or mimic the structure
             SomeProject/
                Sources/
                Resources/
                WebServerResources/
                Components/
         when you create a new project.
         Additionally, you might want to add your subproject in the dependency hierachy
         and add it to the "all.web" "all.clean" and "all.install" tasks 
     -->

    <target name="SomeNewProject.all">
         <!-- project.type, either "global.application" or "global.framework" -->
         <antcall target="global.application.${build.action}" >

            <!-- princical class if the framework or Application class -->
            <param name="project.principal.class" value="com.company.Application" />

            <!-- Name of the framework or application -->
            <param name="project.name" value="SomeNewProject" />

            <!-- Path where the project resides, can be absolute -->
            <param name="project.dir" value="/path/to/your/project" />

            <!-- set this if you want to use plain D2W, or leave out if not -->
            <param name="use.webobjects.d2w" value="true" />

            <!-- set this if you want to use Wonders ERJars or leave out if not -->
            <param name="use.wonder.jars" value="true" />

            <!-- set this if you want to use Wonders ERJars and ERExtensions, or leave out if not -->
            <param name="use.wonder.core" value="true" />

            <!-- set this if you want to use Wonders D2W, or leave out if not -->
            <param name="use.wonder.d2w" value="true" />

            <!-- set this if you want to use Wonder's ERCoreBusinessLogic, or leave out if not -->
            <param name="use.wonder.logic" value="true" />

            <!-- set this if you want to use Wonder's ERJavaMail, or leave out if not -->
            <param name="use.wonder.mail" value="true" />

            <!-- set this if you want to use Wonder's ERIndexing, or leave out if not -->
            <param name="use.wonder.indexing" value="true" />

            <!-- set this if you want to use Wonder's ERChangeNotificationJMS, or leave out if not -->
            <param name="use.wonder.changenotification" value="true" />

            <!-- set this if you want to use Wonder's DynaGrouping, or leave out if not -->
            <param name="use.grouping" value="true" />

            <!-- set this if you want to use Wonder's DynaReporting, or leave out if not -->
            <param name="use.reporting" value="true" />

            <!-- set this if you want to use your own built frameworks, or leave out if not -->
            <!-- You have up to 9 of them and you can use patterns -->
            <param name="use.additional.framework.1" value="BTBusinessLogic.framework" />
            <param name="use.additional.framework.2" value="SomeOther*" />
            <param name="use.additional.framework.3" value="BT*" />
            <param name="use.additional.framework.4" value="BTBusinessLogic" />

            <!-- set this if you want to use SVGObjects, or leave out if not -->
            <param name="use.svgobjects" value="true" />

            <!-- set this if you want to use Validity, or leave out if not -->
            <param name="use.validity" value="true" />

            <!-- set this if you want to use WOOgnl, or leave out if not -->
            <param name="use.woognl" value="true" />

            <!-- set this if you want to use ExcelGenerator, or leave out if not -->
            <param name="use.excel" value="true" />

            <!-- set this if you want to use MySQL, or leave out if not -->
            <param name="use.mysql" value="true" />
        </antcall>
    </target>
    <!-- /When you add another sub-project, use this as a template -->

    <target name="generic">
        <antcall target="generic.all" />
    </target>
    <target name="generic.all">
        <antcall target="global.${project.type}.build" >
            <param name="project.principal.class" value="${project.principal.class}" />
            <param name="project.name" value="${project.name}" />
            <param name="project.dir" value="${project.dir}" />
        </antcall>
    </target>
    <target name="generic.clean">
        <antcall target="global.${project.type}.clean" >
            <param name="project.name" value="${project.name}" />
        </antcall>
    </target>
    <target name="generic.install">
        <antcall target="global.${project.type}.install" >
            <param name="project.name" value="${project.name}" />
        </antcall>
    </target>
    <target name="generic.web">
        <antcall target="global.${project.type}.web" >
            <param name="project.name" value="${project.name}" />
        </antcall>
    </target>
    <target name="global.dummy" />
   
   <target name="global.environment">
        <property name="wonder.root" value="${basedir}" />
        <property file="${wonder.root}/build.properties" />
        <property file="${user.home}/Library/wobuild.properties" />
        <property file="${wonder.root}/Build/build/default.properties" />

        <!-- default values. can be overridden by *.properties files or -D options. -->
        <property name="wo.wosystemroot" value="/System" />
        <property name="wo.localroot" value="/" />
        <property name="before.compile" value="global.dummy" />
        <property name="after.compile" value="global.dummy" />
        <property name="project.customInfo.plist" value="" />
        
        <property name="wo.frameworks" value="${wo.wosystemroot}/Library/Frameworks" />
        <property name="wo.local.frameworks" value="${wo.wolocalroot}/Library/Frameworks" />
        <property name="build.root" value="${user.home}/Roots" />
        <property name="build.classes" value="${build.root}/classes/${project.name}" />
        <property name="wonder.development" value="true" />
        
        <!-- if project.type is application and wonder.development is false, use installed frameworks, 
             otherwise use development frameworks. --> 
        <condition property="wonder.lib.root" value="${wo.localroot}/Library/Frameworks">
            <and>
                <equals arg1="${project.type}" arg2="application" />
                <isfalse value="${wonder.development}"/>
            </and>
        </condition>
        <property name="wonder.lib.root" value="${build.root}" />
        <property name="wonder.framework.install.root" value="${wo.localroot}/Library/Frameworks" />
        <property name="wonder.jar.install.root" value="${wo.localroot}/Library/WebObjects/lib" />
        <property name="web.framework.install.root" value="${wo.server.root}/Frameworks" />
        <property name="wonder.application.install.root" value="${wo.localroot}/Library/WebObjects/JavaApplications" />
        <property name="web.application.install.root" value="${wo.server.root}" />
        <!-- just some existing value -->
        <property name="project.sources.dir" value="${project.dir}/Sources" />
        <property name="patches.dir" value="${wonder.root}/Build/build" />
        <property name="classes.exclude.0" value="does_not_exists_hopefully" />
        <property name="classes.exclude.1" value="does_not_exists_hopefully" />
        <property name="classes.exclude.2" value="does_not_exists_hopefully" />
    </target>

    <target name="global.properties" depends="global.environment">
        <property name="framework.name" value="${project.name}.framework" />
        <property name="build.framework.dir" value="${build.root}/${framework.name}" />
    </target>

    <target name="global.prepare" depends="global.properties">
        <path id="ant.classpath">
            <fileset dir="${wonder.root}/Build/">
                <include name="lib/*.jar"/>
            </fileset>
        </path>
        <mkdir dir="${project.dir}/Libraries" />
        <mkdir dir="${project.sources.dir}" />
        <mkdir dir="${project.dir}/Resources" />
        <mkdir dir="${project.dir}/Components" />
        <mkdir dir="${project.dir}/WebServerResources" />
        <mkdir dir="${build.root}" />
        <mkdir dir="${build.classes}" />
    </target>

    <target name="dist.properties" depends="global.environment">
        <property name="project.source.dir" value="${wonder.root}/${project.dir}" />
    </target>

    <target name="global.framework.dist" depends="dist.properties">
        <property name="framework.name" value="${project.name}.framework" />

        <copy todir="${dist.dir}/Frameworks/${framework.name}">
            <fileset dir="${build.root}/${framework.name}" />
        </copy>

        <mkdir dir="${build.root}/${framework.name}/WebServerResources" />
        <copy todir="${dist.dir}/WebServerResources/Frameworks/${framework.name}" includeEmptyDirs="false">
            <fileset dir="${build.root}/${framework.name}/WebServerResources" />
        </copy>

        <mkdir dir="${project.source.dir}/Documentation" />
        <copy todir="${dist.dir}/Documentation/Frameworks/${framework.name}" includeEmptyDirs="false">
            <fileset dir="${project.source.dir}/Documentation">
                <exclude name="**/CVS/*" />
            </fileset>
        </copy>

        <mkdir dir="${project.source.dir}/Support" />
        <copy todir="${dist.dir}/Documentation/Frameworks/${framework.name}/Support" includeEmptyDirs="false">
            <fileset dir="${project.source.dir}/Support">
                <exclude name="**/CVS/*" />
            </fileset>
        </copy>
    </target>

    <target name="global.application.dist" depends="dist.properties">
        <property name="application.name" value="${project.name}.woa" />

        <copy todir="${dist.dir}/Applications/${application.name}">
            <fileset dir="${build.root}/${application.name}" />
        </copy>
        
        <chmod file="${dist.dir}/Applications/${application.name}/${project.name}" perm="ugo+rx"/>

        <mkdir dir="${build.root}/${application.name}/Contents/WebServerResources" />
        <copy todir="${dist.dir}/WebServerResources/${application.name}/Contents/WebServerResources" includeEmptyDirs="false">
            <fileset dir="${build.root}/${application.name}/Contents/WebServerResources" />
        </copy>

        <mkdir dir="${project.source.dir}/Documentation" />
        <copy todir="${dist.dir}/Documentation/Applications/${project}" includeEmptyDirs="false">
            <fileset dir="${project.source.dir}/Documentation">
                <exclude name="**/CVS/*" />
            </fileset>
        </copy>

        <mkdir dir="${project.source.dir}/Support" />
        <copy todir="${dist.dir}/Documentation/Applications/${project}/Support" includeEmptyDirs="false">
            <fileset dir="${project.source.dir}/Support">
                <exclude name="**/CVS/*" />
            </fileset>
        </copy>
    </target>

    <target name="global.compile" depends="global.environment,global.prepare">
         <taskdef name="wocompile" classname="org.objectstyle.woproject.ant.WOCompile">
            <classpath refid="ant.classpath"/>
        </taskdef>
        <echo message="${project.sources.dir}" />
         
       <antcall target="${before.compile}" />
       <wocompile srcdir="${project.sources.dir}" destdir="${build.classes}" debug="on" optimize="off" deprecation="off" source="${compiler.source}" target="${compiler.target}" >
                    <exclude name="${classes.exclude.0}" />
                    <exclude name="${classes.exclude.1}" />
                    <exclude name="${classes.exclude.2}" />
            <classpath>
                <fileset dir="${project.dir}/Libraries">
                    <include name="**/*.jar" />
                    <!-- ak: i know, fix this...-->
                </fileset>
            </classpath>
           <frameworks dir="${wonder.lib.root}" if="wonder.lib.root.bundles" bundles="${wonder.lib.root.bundles}" embed="${wonder.lib.root.bundles.embed}"/>
           <frameworks dir="${wo.frameworks}" if="wo.frameworks.bundles" bundles="${wo.frameworks.bundles}" embed="${wo.frameworks.bundles.embed}" />
           <frameworks dir="${wo.frameworks}"> 
                <include name="JavaFoundation.framework" />
                <include name="JavaEOAccess.framework" />
                <include name="JavaEOControl.framework" />
                <include name="JavaWebObjects.framework" />
                <include name="JavaWOJSPServlet.framework" />
                <include name="JavaPlot.framework" />
                <include name="JavaJDBCAdaptor.framework" />
                <include name="JavaXML.framework" />
            </frameworks>
            <frameworks dir="${wo.frameworks}" if="use.webobjects.d2w"> 
                <include name="JavaDirectToWeb.framework" />
                <include name="JavaEOProject.framework" />
                <include name="JavaDTWGeneration.framework" />
            </frameworks>
        </wocompile>
        <antcall target="${after.compile}" />
    </target>

    <target name="global.framework.build" depends="global.properties,global.compile">
        <mkdir dir="${build.framework.dir}" />
        <taskdef name="woframework" classname="org.objectstyle.woproject.ant.WOFramework">
            <classpath refid="ant.classpath"/>
        </taskdef>

        <woframework name="${project.name}" destDir="${build.root}" principalClass="${project.principal.class}" jarName="${project.name}" version="${project.version}" customInfoPListContent="${project.customInfo.plist}">
            <lib dir="${project.dir}/Libraries">
                <include name="**/*.jar" />
            </lib>
            <classes dir="${build.classes}">
                <include name="**/*.class" />
                    <exclude name="${classes.exclude.0}" />
                    <exclude name="${classes.exclude.1}" />
                    <exclude name="${classes.exclude.2}" />
            </classes>
            <classes dir="${project.sources.dir}">
                <include name="**/*" />
                <exclude name="**/*.class" />
                <exclude name="**/*.java" />
                <exclude name="**/.svn" />
                <exclude name="**/CVS" />
            </classes>
            <sources dir="${project.sources.dir}" if="include.source">
                <include name="**/*.java" />
            </sources>
            <resources dir="${project.dir}/Components">
                <include name="**.api" />
                <include name="**/*.wo/**" />
            </resources>
            <resources dir="${project.dir}/Resources">
                <include name="**/*" /> 
                <exclude name="*.*~/" />
            </resources>
            <wsresources dir="${project.dir}/WebServerResources">
                <include name="**/*" />
            </wsresources>
        </woframework>
        
        <jar destfile="${build.root}/${project.name}-${project.version}.jar">
            <fileset dir="${build.classes}">
                    <exclude name="${classes.exclude.0}" />
                    <exclude name="${classes.exclude.1}" />
                    <exclude name="${classes.exclude.2}" />
            </fileset>
            <fileset dir="${build.root}/${project.name}.framework/" includes="Resources/**/*" excludes="**/*.jar"/>
            <fileset dir="${build.root}/${project.name}.framework/" includes="WebServerResources/**/*"/>
        </jar>

        <echo message="-------------------------------------" />
        <echo message="${project.name}.framework done" />
        <echo message="-------------------------------------" />
    </target>

    <target name="global.application.build" depends="global.properties,global.compile" >

        <taskdef name="woapplication" classname="org.objectstyle.woproject.ant.WOApplication">
            <classpath refid="ant.classpath"/>
        </taskdef>
        <condition property="use.system.bundles">
            <not><isset property="wo.frameworks.bundles"/></not>
        </condition>
        <woapplication name="${project.name}" destDir="${build.root}" principalClass="${project.principal.class}" jarName="${project.name}" stdFrameworks="false" version="${project.version}">
            <classes dir="${build.classes}">
                <include name="**/*.class" />
                <exclude name=".svn" />
                <exclude name=".CVS" />
            </classes>
            <classes dir="${project.sources.dir}">
                <include name="**/*" />
                <exclude name="**/*.java" />
                <exclude name="**/*.class" />
                <exclude name="**/.svn" />
                <exclude name="**/CVS" />
            </classes>
            <sources dir="${project.sources.dir}" if="include.source">
                <include name="**/*.java" />
            </sources>
            <lib dir="${project.dir}/Libraries">
                <include name="**/*.jar" />
            </lib>
            <resources dir="${project.dir}/Components">
                <include name="**.api" />
                <include name="**/*.wo/**" />
            </resources>
            <resources dir="${project.dir}/Resources">
                <include name="**/*" /> 
            </resources>
            <wsresources dir="${project.dir}/WebServerResources">
                <include name="**/*" />
            </wsresources>
            
            <!-- this should be an exact copy of the frameworks in the woapplication task --> 
           <frameworks dir="${wonder.lib.root}" if="wonder.lib.root.bundles" bundles="${wonder.lib.root.bundles}" embed="${wonder.lib.root.bundles.embed}"/>
           <frameworks dir="${wo.frameworks}" if="wo.frameworks.bundles" bundles="${wo.frameworks.bundles}" embed="${wo.frameworks.bundles.embed}" />
           <frameworks dir="${wo.localroot}/Library/Frameworks" if="use.movies">
                <include name="JavaBusinessLogic.framework"/>
           </frameworks>
            <frameworks dir="${wo.localroot}/Library/Frameworks" if="use.mysql">
                <include name="*PlugIn.framework"/>
           </frameworks>
           <frameworks dir="${wo.wosystemroot}/Library/Frameworks" if="use.system.bundles"> 
                <include name="JavaFoundation.framework" />
                <include name="JavaEOAccess.framework" />
                <include name="JavaEOControl.framework" />
                <include name="JavaWebObjects.framework" />
                <include name="JavaWOJSPServlet.framework" />
                <include name="JavaPlot.framework" />
                <include name="JavaJDBCAdaptor.framework" />
                <include name="JavaXML.framework" />
            </frameworks>
            <frameworks dir="${wo.wosystemroot}/Library/Frameworks" if="use.webobjects.webservices.server"> 
                <include name="JavaWebServices*.framework" />
            </frameworks>
            <frameworks dir="${wo.wosystemroot}/Library/Frameworks" if="use.webobjects.d2w"> 
                <include name="JavaDirectToWeb.framework" />
                <include name="JavaEOProject.framework" />
                <include name="JavaDTWGeneration.framework" />
            </frameworks>
        </woapplication>
        <exec dir="${build.root}/${project.name}.woa" executable="/bin/chmod" os="Mac OS X">
            <arg line="a+x ${project.name}" />
        </exec>
        <exec dir="${build.root}/${project.name}.woa/Contents/MacOS" executable="/bin/chmod" os="Mac OS X">
            <arg line="a+x ${project.name}" />
        </exec>
    </target>

    <target name="global.framework.install" depends="global.properties">
        <copy todir="${wonder.framework.install.root}/${project.name}.framework">
            <fileset dir="${build.root}/${project.name}.framework" />
        </copy>
        <copy todir="${wonder.jar.install.root}/">
            <fileset file="${build.root}/${project.name}-${project.version}.jar" />
        </copy>
    </target>

    <target name="global.application.install" depends="global.properties">
         <mkdir dir="${wonder.application.install.root}" />
         <copy todir="${wonder.application.install.root}/${project.name}.woa">
            <fileset dir="${build.root}/${project.name}.woa" />
        </copy>
        <exec dir="${wonder.application.install.root}/${project.name}.woa" executable="/bin/chmod" os="Mac OS X">
            <arg line="a+x ${project.name}" />
        </exec>
    </target>
    
    <!-- compatibility with prior scripts -->
    <target name="global.framework" depends="global.framework.build">
    </target>
    <target name="global.application" depends="global.application.build">
    </target>
    <!-- /compatibility -->
    
    <target name="global.framework.web" depends="global.properties">
        <mkdir dir="${web.framework.install.root}/${project.name}.framework" />
        <copy todir="${web.framework.install.root}/${project.name}.framework/WebServerResources">
            <fileset dir="${build.root}/${project.name}.framework/WebServerResources" />
        </copy>
    </target>
	
    <target name="global.application.web" depends="global.properties">
        <mkdir dir="${web.application.install.root}/${project.name}.woa" />
        <mkdir dir="${web.application.install.root}/${project.name}.woa/Contents" />
        <copy todir="${web.application.install.root}/${project.name}.woa/Contents/WebServerResources">
            <fileset dir="${build.root}/${project.name}.woa/Contents/WebServerResources" />
        </copy>
    </target>
	
    <target name="global.framework.clean" depends="global.properties">
        <delete dir="${build.classes}" />
        <delete dir="${build.root}/${project.name}.framework" />
    </target>
	
    <target name="global.application.clean" depends="global.properties">
        <delete dir="${build.classes}" />
        <delete dir="${build.root}/${project.name}.woa" />
    </target>
</project>
