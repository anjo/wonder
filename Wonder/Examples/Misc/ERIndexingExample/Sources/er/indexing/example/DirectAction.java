package er.indexing.example;
// Generated by the WOLips Templateengine Plug-in at 12.06.2008 11:20:01

import com.webobjects.appserver.WOActionResults;
import com.webobjects.appserver.WORequest;
import com.webobjects.eocontrol.EOEditingContext;

import er.directtoweb.ERD2WDirectAction;
import er.extensions.eof.ERXEC;
import er.indexing.ERIndex;
import er.indexing.example.eof.Asset;
import er.indexing.example.eof.AssetGroup;
import er.indexing.example.eof.Tag;

public class DirectAction extends ERD2WDirectAction {

    public DirectAction(WORequest aRequest) {
        super(aRequest);
    }
   
    /**
     * Checks if a page configuration is allowed to render.
     * Provide a more intelligent access scheme as the default just returns false. And
     * be sure to read the javadoc to the super class.
     * @param pageConfiguration
     * @return
     */
    protected boolean allowPageConfiguration(String pageConfiguration) {
        return true;
    }

    public WOActionResults defaultAction() {
    	EOEditingContext ec = ERXEC.newEditingContext();
    	ec.lock();
    	try {
    		Tag tag = Tag.clazz.allObjects(ec).lastObject();
    		Asset asset = Asset.clazz.allObjects(ec).lastObject();
    		AssetGroup assetGroup = AssetGroup.clazz.allObjects(ec).lastObject();
    		// new DataCreator().createDummyData();
    		ERIndex eofStore = Application.model.indexNamed("AssetInEOFStore");
    		ERIndex fileStore = Application.model.indexNamed("AssetInFileStore");
    		log.info("fileStore: " + fileStore.find(ec, "tags.name", tag.name()).count());
    		log.info("eofStore: " + eofStore.find(ec, "tags.name", tag.name()).count());
    		log.info("fileStore: " + fileStore.find(ec, "assetGroup.name", assetGroup.name()).count());
    		log.info("eofStore: " + eofStore.find(ec, "assetGroup.name", assetGroup.name()).count());
    		
    		String newName = "cooltest";
    		
    		tag.setName(newName + " " + System.currentTimeMillis());
    		ec.saveChanges();
    		
    		assetGroup.setName(newName + "  " + System.currentTimeMillis());
    		ec.saveChanges();
    		log.info("fileStore 1: " + fileStore.find(ec, "tags.name", newName).count());
    		log.info("eofStore 1: " + eofStore.find(ec, "tags.name", newName).count());
    		try {
    			if(true) {
    				Thread.sleep(2000);
    			}
    			log.info("fileStore 2: " + fileStore.find(ec, "tags.name", newName).count());
    			log.info("eofStore 2: " + eofStore.find(ec, "tags.name", newName).count());
    		} catch (InterruptedException e) {
    			// TODO Auto-generated catch block
    			e.printStackTrace();
    		}
    	} finally {
    		ec.unlock();
    	}
        return pageWithName(Main.class.getName());
    }
}