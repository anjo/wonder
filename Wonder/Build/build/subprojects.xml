<project name="common" default="all" basedir="../..">

    <target name="properties">
        <property name="framework.name" value="${project.name}.framework" />
        <property name="build.classes" value="${build.root}/classes/${project.name}" />
        <property name="build.framework.dir" value="${build.root}/${framework.name}" />
        <property name="build.jar.file" value="${build.framework.dir}/Resources/Java/${project.name}.jar" />
        <property name="build.temp.dir" value="${build.root}/tmp$" />

        <path id="project.class.path">
            <fileset dir="${build.root}">
                <include name="ER*.framework/Resources/Java/*.jar" />
                <include name="BT*.framework/Resources/Java/*.jar" />
                <include name="Validity.framework/Resources/Java/*.jar" />
            </fileset>
            <fileset dir="${wo.woroot}/Library/Frameworks">
                <include name="Java**/Resources/Java/*.jar" />
                <exclude name="JavaWOExtensions.framework"/>
            </fileset>
        </path>
    </target>

    <target name="usage">
        <echo message="-------------------------------------" />
        <echo message="Valid target-commands" />
        <echo message="---------------------" />
        <echo message="  all       --> create framework in ${build.root} " />
        <echo message="  install   --> copy framework to ${wo.local.root} " />
        <echo message="  web       --> copy framework to ${wo.server.root} " />
        <echo message="  clean     --> remove .classes and .framework" />
        <echo message="  allclean  --> remove .classes and .framework and installed framework" />
        <echo message="--------------------------------------" />
    </target>
    <target name="prepare" depends="properties">
        <mkdir dir="${project.dir}/Libraries" />
        <mkdir dir="${project.dir}/Sources" />
        <mkdir dir="${project.dir}/Resources" />
        <mkdir dir="${project.dir}/Components" />
        <mkdir dir="${project.dir}/WebServerResources" />
        <mkdir dir="${build.root}" />
        <mkdir dir="${build.classes}" />
    </target>
        
    <target name="checkupdate">
        <uptodate property="no.changes" targetfile="${build.jar.file}">
            <srcfiles dir="${project.dir}/Sources" />
        </uptodate>
    </target>

    <target name="compile" depends="prepare,checkupdate" description="Default compile target" unless="no.changes">
        <mkdir dir="${build.classes}" />
        <javac srcdir="${project.dir}/Sources" destdir="${build.classes}" debug="on" optimize="off" deprecation="on">
            <classpath> 
                <fileset dir="${project.dir}/Libraries">
                    <include name="**/*.jar" />
                </fileset>
                <path refid="project.class.path" />
            </classpath>
        </javac>
    </target>

    <target name="framework" depends="properties,compile" description="Default compile target">
        <mkdir dir="${build.temp.dir}" />
        <copy todir="${build.temp.dir}/${project.name}/WebServerResources" flatten="true">
            <fileset dir="${project.dir}/WebServerResources" />
        </copy>

        <mkdir dir="${build.framework.dir}" />
        <taskdef name="woframework" classname="org.objectstyle.woproject.ant.WOFramework">
            <classpath refid="project.class.path" />
        </taskdef>
        <woframework name="${project.name}" destDir="${build.root}" principalClass="${project.principal.class}" jarName="${project.name}">
            <lib dir="${project.dir}/Libraries">
                <include name="**/*.jar" />
            </lib>
            <classes dir="${build.classes}">
                <include name="**/*.class" />
            </classes>
            <resources dir="${project.dir}/Components">
                <include name="**.api" />
                <include name="**/*.wo/**" />
            </resources>
            <resources dir="${project.dir}/Resources">
                <include name="*.eomodeld/**" />
                <include name="**/*.plist" />
                <include name="**/*.d2wmodel" />
                <include name="**/Properties" />
                <include name="**/*.strings" />
                <include name="**/*.sh" />
                <include name="**/GSVUtilityParser.jj" /> <!-- Validity specific --> 
            </resources>
            <wsresources dir="${build.temp.dir}/${project.name}/WebServerResources">
                <include name="**/*.gif" />
                <include name="**/*.jpeg" />
                <include name="**/*.js" />
                <include name="**/*.css" />
            </wsresources>
        </woframework>

        <delete dir="${build.temp.dir}" />

        <echo message="-------------------------------------" />
        <echo message="${project.name}.framework" />
        <echo message="-------------------------------------" />

    </target>


    
    <target name="Validity.application" depends="properties,compile" description="Default compile target">
        <mkdir dir="${build.temp.dir}" />
        <copy todir="${build.temp.dir}/${project.name}/WebServerResources" flatten="true">
            <fileset dir="${project.dir}/WebServerResources" />
        </copy>

        <taskdef name="woapplication" classname="org.objectstyle.woproject.ant.WOApplication">
            <classpath refid="project.class.path" />
        </taskdef>
        <woapplication name="${project.name}" destDir="${build.root}" principalClass="${project.principal.class}" jarName="${project.name}" stdFrameworks="false">
            <classes dir="${build.classes}">
                <include name="**/*.class" />
            </classes>
            <resources dir="${project.dir}/Components">
                <include name="**.api" />
                <include name="**/*.wo/**" />
            </resources>
            <resources dir="${project.dir}/Resources">
                <include name="*.eomodeld/**" />
                <include name="**/*.plist" />
                <include name="**/*.d2wmodel" />
                <include name="**/Properties" />
                <include name="**/*.strings" />
                <include name="**/*.sh" />
            </resources>
            <wsresources dir="${build.temp.dir}/${project.name}/WebServerResources">
                <include name="**/*.gif" />
                <include name="**/*.jpeg" />
                <include name="**/*.js" />
                <include name="**/*.css" />
            </wsresources>
            <frameworks root="wo.woroot">
                <include name="Library/Frameworks/JavaFoundation.framework" />
                <include name="Library/Frameworks/JavaEOControl.framework" />
                <include name="Library/Frameworks/JavaEOAccess.framework" />
                <include name="Library/Frameworks/JavaWebObjects.framework" />
                <include name="Library/Frameworks/JavaJDBCAdaptor.framework" />
                <include name="Library/Frameworks/JavaWOExtensions.framework" />
                <include name="Library/Frameworks/JavaXML.framework" />
            </frameworks>
            <frameworks root="${build.root}">
                <include name="Validity.framework" />
            </frameworks>
        </woapplication>

        <delete dir="${build.temp.dir}" />
        
        <echo message="-------------------------------------" />
        <echo message="${project.name}.woa" />
        <echo message="-------------------------------------" />
    </target>

    <target name="install" depends="all">
        <copy todir="${wo.local.root}/${framework.name}">
            <fileset dir="${build.framework.dir}" />
        </copy>
    </target>

    <target name="web" depends="framework">
        <copy todir="${wo.server.root}/${framework.name}/WebServerResources">
            <fileset dir="${build.framework.dir}/WebServerResources" />
        </copy>
    </target>
	
    <target name="clean" depends="properties">
        <echo message="-------------------------------------" />
        <echo message="${project.dir}" />
        <echo message="-------------------------------------" />
        <delete dir="${build.classes}" />
        <delete dir="${build.framework.dir}" />
    </target>
	
    <!-- WOPayPal -->
    <target name="WOPayPal.all">
        <antcall target="framework" >
            <param name="project.principal.class" value="" />
            <param name="project.name" value="WOPayPal" />
            <param name="project.dir" value="${wonder.root}/PayPal/Frameworks/WOPayPal" />
        </antcall>
    </target>
    <target name="WOPayPal.clean">
        <antcall target="clean" >
            <param name="project.principal.class" value="" />
            <param name="project.name" value="WOPayPal" />
            <param name="project.dir" value="${wonder.root}/PayPal/Frameworks/WOPayPal" />
        </antcall>
    </target>

    <!-- Validity Framework -->
    <target name="Validity.framework.all">
        <antcall target="framework" >
            <param name="project.principal.class" value="" />
            <param name="project.name" value="Validity" />
            <param name="project.dir" value="${wonder.root}/Validity/Frameworks/Validity" />
        </antcall>
    </target>
    <target name="Validity.framework.clean">
        <antcall target="clean" >
            <param name="project.principal.class" value="" />
            <param name="project.name" value="Validity" />
            <param name="project.dir" value="${wonder.root}/Validity/Frameworks/Validity" />
        </antcall>
    </target>

    <!-- Validity Application -->
    <target name="Validity.application.all">
        <antcall target="Validity.application" >
            <param name="project.principal.class" value="" />
            <param name="project.name" value="ValidityModeler" />
            <param name="project.dir" value="${wonder.root}/Validity/Applications/ValidityModeler" />
        </antcall>
    </target>
    <target name="Validity.application.clean">
        <antcall target="clean" >
            <param name="project.principal.class" value="" />
            <param name="project.name" value="ValidityModeler" />
            <param name="project.dir" value="${wonder.root}/Validity/Applications/ValidityModeler" />
        </antcall>
    </target>

    <!-- Validity Example -->
    <target name="Validity.example.all">
        <antcall target="Validity.application" >
            <param name="project.principal.class" value="" />
            <param name="project.name" value="ValidityExample" />
            <param name="project.dir" value="${wonder.root}/Validity/Examples/ValidityExample" />
        </antcall>
    </target>
    <target name="Validity.example.clean">
        <antcall target="clean" >
            <param name="project.principal.class" value="" />
            <param name="project.name" value="ValidityExample" />
            <param name="project.dir" value="${wonder.root}/Validity/Examples/ValidityExample" />
        </antcall>
    </target>
	
    <target name="Validity.base" depends="Validity.framework.all, Validity.application.all" />
    <target name="Validity.all" depends="Validity.base, Validity.example.all" />

    <target name="all" depends="WOPayPal.all, Validity.all" />
	
    <target name="all.clean" depends="WOPayPal.clean, Validity.framework.clean, Validity.application.clean, Validity.example.clean" />
</project>
