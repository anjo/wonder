package er.reporting;

import er.grouping.*;
import java.lang.*;
import java.util.*;
import java.io.*;
import com.webobjects.foundation.*;
import com.webobjects.eocontrol.*;
import com.webobjects.eoaccess.*;
import com.webobjects.appserver.*;

// Generated by the WebObjects Wizard Sun Feb 07 12:23:53 US/Central 1999
public class WRQuickReport extends WOComponent  {
    private er.extensions.ERXLogger log = er.extensions.ERXLogger.getERXLogger(WRQuickReport.class);
    protected DRReportModel _model;
    
    public WRQuickReport(WOContext c){
        super(c);
    }


    public boolean synchronizesVariablesWithBindings() {
        return false;
    }


    public String plistString() {
        if (this.hasBinding("plistString")) {
            return (String)this.valueForBinding("plistString");
        } else {
            if (this.hasBinding("pathString")) {
                String p = (String)this.valueForBinding("pathString");
                log.debug( "p:"+p);
                String plist = _NSStringUtilities.stringFromFile(p);
                log.debug( "plist:"+plist);
                return plist;
                
                //return _NSUtilities.stringWithContentsOfFile(p);
            }

        }

        return null;
    }


    public NSArray criteriaArray() {
        if (this.hasBinding("criteriaArray")) {
            return (NSArray)this.valueForBinding("criteriaArray");
        }

        return null;
    }


    public NSArray attributeArray() {
        if (this.hasBinding("attributeArray")) {
            return (NSArray)this.valueForBinding("attributeArray");
        }

        return null;
    }


    public void appendToResponse(WOResponse r, WOContext c) {
        NSArray aCritArray = (NSArray)this.criteriaArray();
        NSArray aAttribArray = (NSArray)this.attributeArray();
        NSArray objs = (NSArray)this.valueForBinding("objects");
        log.debug( "objs count: "+(objs.count())+" ");

        if (aCritArray == null) {
            String ps = this.plistString();
            log.debug( "ps:"+ps);

            if (ps != null) {
                NSDictionary modelDict = DRReportModel.modelDictWithPListString(ps);
                aCritArray = (NSArray)modelDict.objectForKey("GroupDef");
                aAttribArray = (NSArray)modelDict.objectForKey("AttributeDef");
                log.debug( "modelDict:"+modelDict);
            }

        }

        if (_model == null) {
            _model = DRReportModel.withRawRecordsCriteriaListAttributeList(objs, aCritArray, aAttribArray);
            log.debug( "_model:"+_model);
        }

        log.debug( "[objs records]: "+(_model.records().count())+" ");
        super.appendToResponse(r, c);
    }



}